---
title: "Earth Overshoot data 2024"
author: "Dr J P McKeown"
output: "html_document"
---

## Data fields for dashboard display: 
Country name,
Sustainability Grade (revised by EO),
Comment (revised by EO).
Sustainable maximum population (calculated as biocapacity/footprint),
Population (2023 from World Bank SP.POP.TOTL),
Population growth rate (most recent available from SP.POP.GROW),
Contraception (most recent Modern methods contraceptive prevalence % SP.DYN.CONM.ZS),
Species threatened (most recent IUCN quarterly),
GDP per person (most recent from World Bank NY.GDP.PCAP.CD),

## Data needed for calculation or processing:
iso3c
Biocapacity per person (GFN 2020 or estimated 2022)
Ecological Footprint per person (GFN 2020 or estimated 2022)

## Other national data fields available:
iso2c
Biocapacity (GFN)
Ecological Footprint (GFN)
Population (2023 from UN WPP)

```{r, setup}
library(tidyverse)
library(countrycode)
library(devtools)
options(timeout = 600)
library(WDI)
```

```{r, stem}
# make stem frame of Countries
eo_temp <- readRDS('data/eop_26April2022.rds')
eo_stem <- eo_temp %>%
  rename(Photos = Freq) %>% 
  relocate(Country, Continent) %>%
  relocate(Photos, .after = Continent) %>% 
  select(Country:iso3c) %>% 
  arrange(Country) # no effect as rds already sorted by country name

# official names of countries
eo_stem$Country[eo_stem$Country == "Democratic Republic of The Congo"] = "Democratic Republic of the Congo"
eo_stem$Country[eo_stem$Country == "Czech Republic / Czechia"] = "Czech Republic"
eo_stem$Country[eo_stem$Country == "Bosnia & Herzegovina"] = "Bosnia and Herzegovina"
eo_stem$Country[eo_stem$Country == "Trinidad & Tobago"] = "Trinidad and Tobago"
eo_stem$Country[eo_stem$Country == "Antigua & Barbuda"] = "Antigua and Barbuda"
eo_stem$Country[eo_stem$Country == "St. Kitts and Nevis"] = "Saint Kitts and Nevis"
eo_stem$Country[eo_stem$Country == "St. Lucia"] = "Saint Lucia"
eo_stem$Country[eo_stem$Country == "St Vincent and the Grenadines"] = "Saint Vincent and the Grenadines"
```

## World Bank data

Population total

```{r}
WB_pop_2023 <- WDI(
  country = 'all',
  indicator = 'SP.POP.TOTL',
  start = 2023,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

# count missing rows
sum(is.na(WB_pop_2023$SP.POP.TOTL))

# identify missing rows
na_row <- WB_pop_2023[is.na(WB_pop_2023$SP.POP.TOTL), ]
print(na_row$country)

head(WB_pop_2023)
```

```{r}
wbpop2023_mergable <- WB_pop_2023 %>% 
  select(iso3c, SP.POP.TOTL)
head(wbpop2023_mergable)
```

```{r}
eo_2024 <- eo_stem %>% 
  left_join(wbpop2023_mergable, by = "iso3c")
head(eo_2024)
```

Population Growth Rate, most recent
```{r, popgrowth}
# get recent year and see if complete all rows
popgrow_2023_WB <- WDI(
  country = 'all',
  indicator = 'SP.POP.GROW',
  start = 2023,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

# count missing rows
sum(is.na(popgrow_2023_WB$SP.POP.GROW))

# identify missing rows
na_row <- popgrow_2023_WB[is.na(popgrow_2023_WB$SP.POP.GROW), ]
print(na_row$country)
```

```{r}
popgrow_2023_wb_mergable <- popgrow_2023_WB %>% 
  select(iso3c, SP.POP.GROW)
```

Add population growth rate to Countries table 
```{r}
eo_2024 <- eo_2024 %>% 
  left_join(popgrow_2023_wb_mergable, by = "iso3c")
head(eo_2024)
```

Contraception, prevalence % modern methods
Only a few countries have data in recent years
```{r, contraception}
contracept_2023_wb <- WDI(
  country = 'all',
  indicator = 'SP.DYN.CONM.ZS',
  start = 2021,
  end = 2021,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

sum(is.na(contracept_2023_wb$SP.DYN.CONM.ZS))

# identify missing rows
na_row <- contracept_2023_wb[is.na(contracept_2023_wb$SP.DYN.CONM.ZS), ]
# print(na_row$country)
```

```{r}
tmp_contracept <- WDI(
  country = 'all',
  indicator = 'SP.DYN.CONM.ZS',
  start = 1984,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)
sum(is.na(tmp_contracept$iso3c))

contraception <- tmp_contracept %>%
  select(iso3c, year, SP.DYN.CONM.ZS, country) %>% 
  group_by(iso3c) %>% 
  filter(!is.na(SP.DYN.CONM.ZS)) %>% 
  slice_max(year)
  
head(contraception)
```

Contraception % and year of most recent data point as mergable columns
```{r}
contracept_2023_wb_mergable <- contraception %>% 
  rename(contracept_year = year) %>% 
  select(iso3c, SP.DYN.CONM.ZS, contracept_year)
head(contracept_2023_wb_mergable,1)
```

Merge contraception data & year into Countries list
```{r}
eo_2024 <- eo_2024 %>% 
  left_join(contracept_2023_wb_mergable, by = "iso3c")
head(eo_2024)
```

GDP per capita, most recent year available
```{r, GDP}
tmp_gdp <- WDI(
  country = 'all',
  indicator = 'NY.GDP.PCAP.CD',
  start = 2011,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)
sum(is.na(tmp_gdp$iso3c)) # =0

gdp_pp_2023_wb <- tmp_gdp %>%
  rename(gdp_year = year) %>% 
  select(iso3c, NY.GDP.PCAP.CD, gdp_year) %>% 
  group_by(iso3c) %>% 
  filter(!is.na(NY.GDP.PCAP.CD)) %>% 
  slice_max(gdp_year)

head(gdp_pp_2023_wb, 1)
```

GDP and year of most recent data point as mergable columns
```{r echo = FALSE, eval = FALSE}
gdp_pp_2023_wb_mergable <- gdp_pp_2023_wb %>% 
  select(iso3c, SP.DYN.CONM.ZS, contracept_year)
head(contracept_2023_wb_mergable,1)
```

Merge GDP data & year into Countries list
```{r}
eo_2024 <- eo_2024 %>% 
  left_join(gdp_pp_2023_wb, by = "iso3c")
head(eo_2024)
```

Archive and export for web sheet
```{r echo = FALSE, eval = FALSE}
saveRDS(eo_stem, file="data/eo_2024.rds")
write_csv(eo_stem, "data/eo_2024.csv")
```