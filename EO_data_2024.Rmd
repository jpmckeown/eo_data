---
title: "Earth Overshoot data 2024"
author: "Dr J P McKeown"
output: "html_document"
---

## Data fields for dashboard display: 
Country name,
Sustainability Grade (revised by EO),
Comment (revised by EO).
Sustainable maximum population (calculated as biocapacity/footprint),
Population (2023 from World Bank SP.POP.TOTL),
Population growth rate (most recent available from SP.POP.GROW),
Contraception (most recent Modern methods contraceptive prevalence % SP.DYN.CONM.ZS),
Species threatened (most recent IUCN quarterly),
GDP per person (most recent from World Bank NY.GDP.PCAP.CD),

## Data needed for calculation or processing:
iso3c
Biocapacity per person (GFN 2020 or estimated 2022)
Ecological Footprint per person (GFN 2020 or estimated 2022)

## Other national data fields available:
iso2c
Biocapacity (GFN)
Ecological Footprint (GFN)
Population (2023 from UN WPP)

```{r, setup}
library(tidyverse)
library(countrycode)
library(devtools)
options(timeout = 600)
library(WDI)
library(readxl)
```

```{r, stem}
# make stem frame of Countries
eo_temp <- readRDS('data/eop_26April2022.rds')
eo_stem <- eo_temp %>%
  rename(Photos = Freq) %>% 
  relocate(Country, Continent) %>%
  relocate(Photos, .after = Continent) %>% 
  select(Country:iso3c) %>% 
  arrange(Country) # no effect as rds already sorted by country name

# official names of countries
eo_stem$Country[eo_stem$Country == "Democratic Republic of The Congo"] = "Democratic Republic of the Congo"
eo_stem$Country[eo_stem$Country == "Czech Republic / Czechia"] = "Czech Republic"
eo_stem$Country[eo_stem$Country == "Bosnia & Herzegovina"] = "Bosnia and Herzegovina"
eo_stem$Country[eo_stem$Country == "Trinidad & Tobago"] = "Trinidad and Tobago"
eo_stem$Country[eo_stem$Country == "Antigua & Barbuda"] = "Antigua and Barbuda"
eo_stem$Country[eo_stem$Country == "St. Kitts and Nevis"] = "Saint Kitts and Nevis"
eo_stem$Country[eo_stem$Country == "St. Lucia"] = "Saint Lucia"
eo_stem$Country[eo_stem$Country == "St Vincent and the Grenadines"] = "Saint Vincent and the Grenadines"
```

## World Bank data

Population total

```{r}
WB_pop_2023 <- WDI(
  country = 'all',
  indicator = 'SP.POP.TOTL',
  start = 2023,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

# count missing rows
sum(is.na(WB_pop_2023$SP.POP.TOTL))

# identify missing rows
na_row <- WB_pop_2023[is.na(WB_pop_2023$SP.POP.TOTL), ]
print(na_row$country)

head(WB_pop_2023)
```

```{r}
wbpop2023_mergable <- WB_pop_2023 %>% 
  select(iso3c, SP.POP.TOTL)
head(wbpop2023_mergable)
```

```{r}
eo_2024 <- eo_stem %>% 
  left_join(wbpop2023_mergable, by = "iso3c")
head(eo_2024)
```

Population Growth Rate, most recent
```{r, popgrowth}
# get recent year and see if complete all rows
popgrow_2023_WB <- WDI(
  country = 'all',
  indicator = 'SP.POP.GROW',
  start = 2023,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

# count missing rows
sum(is.na(popgrow_2023_WB$SP.POP.GROW))

# identify missing rows
na_row <- popgrow_2023_WB[is.na(popgrow_2023_WB$SP.POP.GROW), ]
print(na_row$country)
```

```{r}
popgrow_2023_wb_mergable <- popgrow_2023_WB %>% 
  select(iso3c, SP.POP.GROW)
```

Add population growth rate to Countries table 
```{r}
eo_2024 <- eo_2024 %>% 
  left_join(popgrow_2023_wb_mergable, by = "iso3c")
head(eo_2024)
```

Contraception, prevalence % modern methods
Only a few countries have data in recent years
```{r, contraception}
contracept_2023_wb <- WDI(
  country = 'all',
  indicator = 'SP.DYN.CONM.ZS',
  start = 2021,
  end = 2021,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

sum(is.na(contracept_2023_wb$SP.DYN.CONM.ZS))

# identify missing rows
na_row <- contracept_2023_wb[is.na(contracept_2023_wb$SP.DYN.CONM.ZS), ]
# print(na_row$country)
```

```{r}
tmp_contracept <- WDI(
  country = 'all',
  indicator = 'SP.DYN.CONM.ZS',
  start = 1984,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)
sum(is.na(tmp_contracept$iso3c))

contraception <- tmp_contracept %>%
  select(iso3c, year, SP.DYN.CONM.ZS, country) %>% 
  group_by(iso3c) %>% 
  filter(!is.na(SP.DYN.CONM.ZS)) %>% 
  slice_max(year)
  
head(contraception)
```

Contraception % and year of most recent data point as mergable columns
```{r}
contracept_2023_wb_mergable <- contraception %>% 
  rename(contracept_year = year) %>% 
  select(iso3c, SP.DYN.CONM.ZS, contracept_year)
head(contracept_2023_wb_mergable,1)
```

Merge contraception data & year into Countries list
```{r}
eo_2024 <- eo_2024 %>% 
  left_join(contracept_2023_wb_mergable, by = "iso3c")
head(eo_2024)
```

TFR add to spreadsheet because it is often used in Country Comments text
Recent data not so sparse as Contraception: 266 missing in 2023; 8 missing in 2022 
Can use 2022 data rather than spanning years and taking two columns for most recent value and year
```{r}
tfr_2022_wb <- WDI(
  country = 'all',
  indicator = 'SP.DYN.TFRT.IN',
  start = 2022,
  end = 2022,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

sum(is.na(tfr_2022_wb$SP.DYN.TFRT.IN))
# identify missing rows
na_row <- tfr_2022_wb[is.na(tfr_2023_wb$SP.DYN.TFRT.IN), ]
print(na_row$country)
```

I did this last after collecting GFN data, therefore used eo_2024_gfn
if placed earlier in script should instead refer to eo_2024
```{r}
tfr_2022_wb_mergable <- tfr_2022_wb %>% 
  select(iso3c, SP.DYN.TFRT.IN)

eo_2024 <- eo_2024 %>% 
  left_join(tfr_2022_wb_mergable, by = "iso3c") %>%
  select(
    Country, Continent, Photos, iso3c,
    SP.DYN.TFRT.IN, # insert TFR (wb) column here
    SP.POP.TOTL, SP.POP.GROW, 
    SP.DYN.CONM.ZS, contracept_year,
    iso2c)

head(eo_2024)
```

GDP per capita, most recent year available
```{r, GDP}
tmp_gdp <- WDI(
  country = 'all',
  indicator = 'NY.GDP.PCAP.CD',
  start = 2011,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)
sum(is.na(tmp_gdp$iso3c)) # =0

gdp_pp_2023_wb <- tmp_gdp %>%
  rename(gdp_year = year) %>% 
  select(iso3c, NY.GDP.PCAP.CD, gdp_year) %>% 
  group_by(iso3c) %>% 
  filter(!is.na(NY.GDP.PCAP.CD)) %>% 
  slice_max(gdp_year)

head(gdp_pp_2023_wb, 1)
```

GDP and year of most recent data point as mergable columns
```{r echo = FALSE, eval = FALSE}
gdp_pp_2023_wb_mergable <- gdp_pp_2023_wb %>% 
  select(iso3c, SP.DYN.CONM.ZS, contracept_year)
head(contracept_2023_wb_mergable,1)
```

Merge GDP data & year into Countries list
```{r}
eo_2024 <- eo_2024 %>% 
  left_join(gdp_pp_2023_wb, by = "iso3c")
head(eo_2024)
```

## IUCN threatened species total by country
Most recent is 2024-1 https://www.iucnredlist.org/support/whatsnew
```{r}
species_2024 = read_csv("data/IUCN_2024_August_Table_5_Threatened_species_by_country.csv")
threat <- species_2024 %>%
  rename(Country = Name) %>% 
  rename(Species = Total) %>% 
  select(Country, Species)
head(threat)
```

Add iso3c column based on name in Country
```{r}
threat$iso3c <- countrycode(sourcevar = threat$Country, 
                        origin = "country.name",
                        destination = "iso3c")
head(threat)
sum(is.na(threat$iso3c))
```

make mergable table of Species threatened per country
```{r}
species_2024_mergable <- threat %>%
  filter(!is.na(iso3c)) %>% 
  rename(Species_2024 = Species) %>% 
  select(iso3c, Species_2024)
head(species_2024_mergable)
```

Merge IUCN Threatened Species into Countries list
```{r}
eo_2024 <- eo_2024 %>% 
  left_join(species_2024_mergable, by = "iso3c")
head(eo_2024)
```

GFN biocapacity and footprint 2019 data from public spreadsheet
In 2023 the data was acquired as JSON files using the API
```{r}
gfn_2019 <- read_excel("NFBA-2023-Public-Data-Package-1.0-1/NFBA_2019.xlsx", col_names = FALSE) %>%
  slice(22:204) %>%
  setNames(make.unique(as.character(.[1,]), sep = "_")) %>%
  slice(-1) %>%
  rename("Population_GFN_2019" = "Population (millions)") %>%
  rename("Biocapacity_2019" = "Total biocapacity") %>%
  rename("Footprint_2019" = "Total Ecological Footprint (Consumption)") %>%
  select(Country, Biocapacity_2019, Footprint_2019, Population_GFN_2019)
head(gfn_2019, 3)
tail(gfn_2019, 2)
colnames(gfn_2019)
```

GFN biocapacity and footprint 2022 estimates from public spreadsheet
```{r}
gfn_2022 <- read_excel("NFBA-2023-Public-Data-Package-1.0-1/NFBA_2022_estimate.xlsx", col_names = FALSE) %>%
  slice(22:204) %>%
  setNames(make.unique(as.character(.[1,]), sep = "_")) %>%
  slice(-1) %>%
  rename("Population_GFN_2022" = "Population (millions)") %>%
  rename("Biocapacity_2022" = "Total biocapacity") %>%
  rename("Footprint_2022" = "Total Ecological Footprint (Consumption)") %>%
  select(Country, Biocapacity_2022, Footprint_2022, Population_GFN_2022)
head(gfn_2022, 3)
tail(gfn_2022, 2)
colnames(gfn_2022)
```

```{r}
gfn_2022 <- gfn_2022 %>%
  mutate(Country_standard = countrycode(Country, origin = 'country.name', destination = 'country.name'))

# Identify countries where the original and standardized names differ
different_names <- gfn_2022 %>%
  filter(Country != Country_standard) %>%
  select(Country, Country_standard)

# Count the number of countries with different names
num_different <- nrow(different_names)

# Print the results
cat("Number of countries with different standard names:", num_different, "\n\n")
print("Countries with different names:")
print(different_names)

# Any countries that couldn't be standardized (NA in Country_standard)
unmatched_countries <- gfn_2022 %>%
  filter(is.na(Country_standard)) %>%
  select(Country)

# cat("\nNumber of countries that couldn't be standardized:", nrow(unmatched_countries), "\n\n")
print("Countries that couldn't be standardized:")
print(unmatched_countries)
```
add standardized country name to eo_2024
```{r}
eo_2024 <- eo_2024 %>%
  mutate(Country_standard = countrycode(iso3c, origin = 'iso3c', destination = 'country.name'))
head(eo_2024, 1)
```

```{r}
eo_2024_gfn <- eo_2024 %>%
  left_join(gfn_2022, by = "Country_standard") %>%
  rename(Country = Country.x) %>%
  select(-Country.y) # delete duplicate column
head(eo_2024_gfn, 1)
```

```{r}
eo_2024_gfn <- eo_2024_gfn %>%
  mutate(across(c(Biocapacity_2022, Footprint_2022, Population_GFN_2022), 
                ~as.numeric(gsub(",", "", .))))
head(eo_2024_gfn, 1)
```

Sustainable population calculated
```{r}
eo_2024_gfn <- eo_2024_gfn %>%
  mutate(Sustainable_pop = round(Population_GFN_2022 * 1000000 * Biocapacity_2022 / Footprint_2022, 0))
head(eo_2024_gfn, 1)
colnames(eo_2024_gfn)
```

Version to cope with missing values not needed, it seems
```{r echo = FALSE, eval = FALSE}
eo_2024_gfn <- eo_2024_gfn %>%
  mutate(Sustainable_pop = if_else(!is.na(Population_GFN_2022) & 
                                   !is.na(Biocapacity) & 
                                   !is.na(Footprint) & 
                                   Footprint != 0,
                                   round(Population_GFN_2022 * 1000000 * Biocapacity / Footprint, 0),
                                   NA_real_))
```

Wait until end before re-arranging columns
```{r echo = FALSE, eval = FALSE}
eo_2024_gfn <- eo_2024_gfn %>%
  select(
    Country, Continent, Photos, iso2c, iso3c, 
    Sustainable_pop,  # Move this column here
    SP.POP.TOTL, SP.POP.GROW, SP.DYN.CONM.ZS, contracept_year, 
    NY.GDP.PCAP.CD, gdp_year, Species_2024, 
    Biocapacity_2022, Footprint_2022, Population_GFN_2022, 
    Country_standard
  )
# select(-Country_standard, everything(), Country_standard) # move standardized name to final column position
```

Taiwan data
```{r, Taiwan}
# https://eng.stat.gov.tw/Point.aspx?sid=t.9&n=4208&sms=11713
Pop_2024_Taiwan <- 23409323
Pop_2019_Taiwan <- 23777737
# https://www.macrotrends.net/global-metrics/countries/TWN/taiwan/population-growth-rate#:~:text=The%20population%20of%20Taiwan%20in,a%200.16%25%20increase%20from%202020.
PopGrowth_Taiwan = 0.11
# https://eng.stat.gov.tw/cp.aspx?n=2334
GDP_pp_Taiwan <- 32474
# https://population.un.org/dataportal/countryProfiles/types/1/topics/5/coreThemes/1/locations/158?classId=reg&palette=Blues&secpalette=alphabet2
# https://www.cia.gov/the-world-factbook/countries/taiwan/ # 75.2
Contracept_Taiwan <- 74.7
# https://www.nature.com/articles/s41598-021-94540-7
Footprint_pp_Taiwan <- 6.46
Biocapacity_pp_Taiwan <- 1.3
# for Sustainable Pop calculation
Sustainable_pop_Taiwan <- floor(Biocapacity_pp_Taiwan / Footprint_pp_Taiwan * Pop_2019_Taiwan)
```

Taiwan insert data in countries table
```{r}
eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "SP.POP.TOTL"] = Pop_2024_Taiwan
eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "SP.POP.GROW"] = 0.11

eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "Sustainable_pop"] = Sustainable_pop_Taiwan

eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "SP.DYN.CONM.ZS"] = Contracept_Taiwan
# eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "Year_contracept"] = # not supplied

eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "NY.GDP.PCAP.CD"] = GDP_pp_Taiwan
eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "gdp_year"] = 2022
# eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "Population_gfn_2019"] = Pop_2019_Taiwan
# eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "Footprint_pp_2019"] = Footprint_pp_Taiwan
# eo_2024_gfn[eo_2024_gfn$iso3c == "TWN", "Biocapacity_pp_2019"] = Biocapacity_pp_Taiwan

```

French Guiana
2019 data, and https://www.insee.fr/fr/statistiques/5020211
https://www.insee.fr/fr/statistiques/fichier/5020211/PIB_regionaux_1990-2022.xlsx
```{r}
GUF_population = 300769
eo_2024_gfn[eo_2024_gfn$iso3c == "GUF", "SP.POP.TOTL"] = GUF_population
eo_2024_gfn[eo_2024_gfn$iso3c == "GUF", "SP.POP.GROW"] = 2.232
eo_2024_gfn[eo_2024_gfn$iso3c == "GUF", "NY.GDP.PCAP.CD"] = 4930000000 / GUF_population
```

Add missing values for 2022 sustainable population, from 2019 JSON data
```{r}
eo_2024_gfn[eo_2024_gfn$iso3c == "BHS", "Sustainable_pop"] = 2212238
eo_2024_gfn[eo_2024_gfn$iso3c == "ISL", "Sustainable_pop"] = 204318
eo_2024_gfn[eo_2024_gfn$iso3c == "LBY", "Sustainable_pop"] = 1523342
eo_2024_gfn[eo_2024_gfn$iso3c == "MDV", "Sustainable_pop"] = 89154
eo_2024_gfn[eo_2024_gfn$iso3c == "SYC", "Sustainable_pop"] = 103834
eo_2024_gfn[eo_2024_gfn$iso3c == "LKA", "Sustainable_pop"] = 6517041
eo_2024_gfn[eo_2024_gfn$iso3c == "KNA", "Sustainable_pop"] = 2506
```

Sustainability Grade column
as of August 2024 still the same as in November 2022
```{r}
grades_2021 = read_csv("data/Grade_2021.csv")
grades_2021 <- grades_2021 %>%
  rename(Grade_2021 = "2021 Grade") %>% 
  select(iso3c, Grade_2021)
head(grades_2021, 1)
```

```{r}
eo_2024_Grade <- eo_2024_gfn %>%
  left_join(grades_2021, by = "iso3c") %>%
  select(
    Country, Continent, Photos, iso3c,
    SP.DYN.TFRT.IN, Grade_2021, # insert column here
    Sustainable_pop, SP.POP.TOTL, SP.POP.GROW, 
    SP.DYN.CONM.ZS, contracept_year, 
    NY.GDP.PCAP.CD, gdp_year, Species_2024, 
    Biocapacity_2022, Footprint_2022, Population_GFN_2022, 
    iso2c, Country_standard
  )
head(eo_2024_Grade, 1)
```

Restart work after shutdown
```{r echo = FALSE, eval = FALSE}
eo_2024_Grade <- readRDS('data/eo_2024.rds')
```

Archive and export for web sheet
or use this in {r } to stop export: echo = FALSE, eval = FALSE
```{r}
saveRDS(eo_2024_Grade, file="data/eo_2024_tfr.rds")
write_csv(eo_2024_Grade, "data/eo_2024_tfr.csv")
```

Save as Excel to include formatting
e.g. centre-aligned columns, width of columns adjusted, bold header
```{r echo = FALSE, eval = FALSE}
library(writexl)
write_xlsx(eo_2024_Grade, 'data/eo_2024_tfr.xlsx')
```

