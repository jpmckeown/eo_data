---
title: "Earth Overshoot data 2024"
author: "Dr J P McKeown"
output: "html_document"
---

## Data fields for dashboard display: 
Country name,
Sustainability Grade (revised by EO),
Comment (revised by EO).
Sustainable maximum population (calculated as biocapacity/footprint),
Population (2023 from World Bank SP.POP.TOTL),
Population growth rate (most recent available from SP.POP.GROW),
Contraception (most recent Modern methods contraceptive prevalence % SP.DYN.CONM.ZS),
Species threatened (most recent IUCN quarterly),
GDP per person (most recent from World Bank NY.GDP.PCAP.CD),

## Data needed for calculation or processing:
iso3c
Biocapacity per person (GFN 2020 or estimated 2022)
Ecological Footprint per person (GFN 2020 or estimated 2022)

## Other national data fields available:
iso2c
Biocapacity (GFN)
Ecological Footprint (GFN)
Population (2023 from UN WPP)

```{r, setup}
library(tidyverse)
library(countrycode)
library(devtools)
options(timeout = 600)
library(WDI)
```

```{r, stem}
# make stem frame of Countries
eo_temp <- readRDS('data/eop_26April2022.rds')
eo_stem <- eo_temp %>%
  rename(Photos = Freq) %>% 
  relocate(Country, Continent) %>%
  relocate(Photos, .after = Continent) %>% 
  select(Country:iso3c) %>% 
  arrange(Country) # no effect as rds already sorted by country name

# official names of countries
eo_stem$Country[eo_stem$Country == "Democratic Republic of The Congo"] = "Democratic Republic of the Congo"
eo_stem$Country[eo_stem$Country == "Czech Republic / Czechia"] = "Czech Republic"
eo_stem$Country[eo_stem$Country == "Bosnia & Herzegovina"] = "Bosnia and Herzegovina"
eo_stem$Country[eo_stem$Country == "Trinidad & Tobago"] = "Trinidad and Tobago"
eo_stem$Country[eo_stem$Country == "Antigua & Barbuda"] = "Antigua and Barbuda"
eo_stem$Country[eo_stem$Country == "St. Kitts and Nevis"] = "Saint Kitts and Nevis"
eo_stem$Country[eo_stem$Country == "St. Lucia"] = "Saint Lucia"
eo_stem$Country[eo_stem$Country == "St Vincent and the Grenadines"] = "Saint Vincent and the Grenadines"
```

## World Bank data

Population total

```{r}
WB_pop_2023 <- WDI(
  country = 'all',
  indicator = 'SP.POP.TOTL',
  start = 2023,
  end = 2023,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

# count missing rows
sum(is.na(WB_pop_2023$SP.POP.TOTL))

na_row <- WB_pop_2022[is.na(WB_pop_2022$SP.POP.TOTL), ]
print(na_row$country) 
head(WB_pop_2023)
```

Archive and export for web sheet
```{r}
saveRDS(eo_stem, file="data/eo_2024.rds")
write_csv(eo_stem, "data/eo_2024.csv")
```