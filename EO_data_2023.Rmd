---
title: "Earth Overshoot data 2023@
author: "JP McKeown"
output: "html_document"
---

## Data fields for dashboard display: 
Country name,
Population (2019 from GFN; or most recent?),
Sustainable maximum population (calculated as biocapacity/footprint),
Contraception (most recent Modern methods contraceptive prevalence % WB SP.DYN.CONM.ZS),
Species threatened (most recent quarterly),
Population growth rate (most recent from WB SP.POP.GROW),
GDP per person (most recent from WB NY.GDP.PCAP.CD),
Sustainability Grade (revised by EO),
Comment (revised by EO).

## Data needed for calculation or processing:
iso3c
Biocapacity per person (GFN 2019)
Ecological Footprint per person (GFN 2019)

## Other national data fields available:
iso2c
Biocapacity (GFN 2019)
Ecological Footprint (GFN 2019)
Population (2022 from WB SP.POP.TOTL)

```{r, setup}
library(tidyverse)
library(countrycode)
library(devtools)
options(timeout = 600)
install_github("PPgp/wpp2022")
library(WDI)
```

```{r, stem}
# make stem frame of Countries
eo_temp <- readRDS('data/eop_26April2022.rds')
eo_stem <- eo_temp %>%
  rename(Photos = Freq) %>% 
  relocate(Country, Continent) %>%
  relocate(Photos, .after = Continent) %>% 
  select(Country:iso3c) %>% 
  arrange(Country) # no effect as rds already sorted by country name

# official names of countries
eo_stem$Country[eo_stem$Country == "Democratic Republic of The Congo"] = "Democratic Republic of the Congo"
eo_stem$Country[eo_stem$Country == "Czech Republic / Czechia"] = "Czech Republic"
eo_stem$Country[eo_stem$Country == "Bosnia & Herzegovina"] = "Bosnia and Herzegovina"
eo_stem$Country[eo_stem$Country == "Trinidad & Tobago"] = "Trinidad and Tobago"
eo_stem$Country[eo_stem$Country == "Antigua & Barbuda"] = "Antigua and Barbuda"
eo_stem$Country[eo_stem$Country == "St. Kitts and Nevis"] = "Saint Kitts and Nevis"
eo_stem$Country[eo_stem$Country == "St. Lucia"] = "Saint Lucia"
eo_stem$Country[eo_stem$Country == "St Vincent and the Grenadines"] = "Saint Vincent and the Grenadines"
```

Merge data from Global Footprint Network: biocapacity, footprint, and population.
```{r, add GFN}
# GFN_2019 <- read_csv("data/GFN_2019.csv")
eo_2023_gfn <- eo_stem %>% 
  left_join(GFN_2019, by = "iso2c") %>% 
  rename(Biocapacity_pp_2019 = biocapacity_pp) %>% 
  rename(Footprint_pp_2019 = footprint_pp) %>%
  rename(Population_gfn_2019 = population) %>% 
  select(Country:iso3c, Biocapacity_pp_2019, Footprint_pp_2019, Population_gfn_2019)
# check France total population
eo_2023_gfn[eo_2023_gfn$iso3c == "FRA",] # 64,436,800
```

Calculate maximum sustainable population
```{r, sustainable}
eo_2023 <- eo_2023_gfn %>% 
  mutate(Sustainable_pop = floor(Biocapacity_pp_2019 / Footprint_pp_2019 * Population_gfn_2019))

```

Interim export for "Country Data" googlesheet
```{r}
# Country Comments are now in a permanent separate tab on googlesheet
write_csv(eo_2023, "data/eo_gfn_maxpop_July_2023.csv")
```

## IUCN threatened species total by country
Most recent is 2022-2 https://www.iucnredlist.org/support/whatsnew
```{r}
species_2022 = read_csv("data/IUCN_July2023download_Table_5 _Threatened_species_by_country.csv")
threat <- species_2022 %>%
  rename(Country = Name) %>% 
  rename(Species = Total) %>% 
  select(Country, Species)
head(threat)
```

Add iso3c based on name Country
```{r}
threat$iso3c <- countrycode(sourcevar = threat$Country, 
                        origin = "country.name",
                        destination = "iso3c")
head(threat)
sum(is.na(threat$iso3c)) # =1 "Disputed territory"
```

## United Nations data
WPP2022 (Population) includes Taiwan
```{r}
library(wpp2022)
data(pop1dt)
head(pop1dt)
pop21 <- pop1dt %>% 
  filter(year == 2021) %>%
  select(country_code, name, pop)
pop21$iso3c = countrycode(sourcevar = pop21$country_code,
                          origin = "iso3n",
                          destination = "iso3c")
pop21 <- pop21 %>% 
  filter(!is.na(iso3c))
# on inspection, only regions are Null iso3c (and Kosovo)

pop21[pop21$iso3c == "FRA",] # 64,560,540
head(pop21)
```

## World Bank data

Population total (compare with UN WPP)
```{r}
WB_pop_2021 <- WDI(
  country = 'all',
  indicator = 'SP.POP.TOTL',
  start = 2021,
  end = 2021,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

# count missing rows = 0
sum(is.na(WB_pop_2021$SP.POP.TOTL))
# if>0, identify missing countries # =1 "Unclassified"

WB_pop_2021[WB_pop_2021$iso3c == "FRA",] # 67,749,632
head(WB_pop_2021)
```

```{r}
WB_pop_2022 <- WDI(
  country = 'all',
  indicator = 'SP.POP.TOTL',
  start = 2022,
  end = 2022,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

# count missing rows = 0
sum(is.na(WB_pop_2022$SP.POP.TOTL))
# if>0, identify missing countries # =1 "Unclassified"

WB_pop_2022[WB_pop_2022$iso3c == "FRA",] # 67,935,660
head(WB_pop_2022)
```

Population Growth Rate, most recent
```{r, popgrowth}
# recent year and see if complete
popgrow_2022 <- WDI(
  country = 'all',
  indicator = 'SP.POP.GROW',
  start = 2022,
  end = 2022,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)

# count missing rows = 0
sum(is.na(pop_2021$SP.POP.GROW))
# if>0, identify missing countries

head(popgrow_2022)
```

Contraception, prevalence % modern methods
```{r, contraception}
tmp_contracept <- WDI(
  country = 'all',
  indicator = 'SP.DYN.CONM.ZS',
  start = 1984,
  end = 2022,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)
sum(is.na(tmp_contracept$iso3c)) # =0

contraception <- tmp_contracept %>%
  select(iso3c, year, SP.DYN.CONM.ZS, country) %>% 
  group_by(iso3c) %>% 
  filter(!is.na(SP.DYN.CONM.ZS)) %>% 
  slice_max(year)
  
head(contraception)
```

GDP per capita
```{r, GDP}
tmp_gdp <- WDI(
  country = 'all',
  indicator = 'NY.GDP.PCAP.CD',
  start = 2011,
  end = 2022,
  extra = FALSE,
  cache = NULL,
  latest = NULL,
  language = 'en'
)
sum(is.na(tmp_contracept$iso3c)) # =0

gdp_pp_2022 <- tmp_gdp %>%
  rename(Year_gdp = year) %>% 
  select(iso3c, Year_gdp, NY.GDP.PCAP.CD, country) %>% 
  group_by(iso3c) %>% 
  filter(!is.na(NY.GDP.PCAP.CD)) %>% 
  slice_max(Year_gdp)
  
head(gdp_pp_2022)
```

Merge pop growth rate % into EO country list data
```{r}
eo_GFN_tmp <- eo_2023
eo_2023 <- eo_GFN_tmp %>% 
  left_join(popgrow_2022, by = "iso3c") %>% 
  rename(Growth_rate_pop = SP.POP.GROW) %>% 
  select(Country:Sustainable_pop, Growth_rate_pop)
head(eo_2023)
```



Taiwan data
https://eng.stat.gov.tw/Point.aspx?sid=t.9&n=4208&sms=11713
```{r, Taiwan}
population_Taiwan <- 23361084
GDP_pp_Taiwan <- 32474

```

